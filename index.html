<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Surat Desa Buareng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Variabel Warna Tema */
        :root {
            --primary-color: #2ca4d3;       /* Warna Utama */
            --primary-dark: #2286ad;        /* Warna Hover */
            --primary-light: rgba(44, 164, 211, 0.1); 
            --bg-color: #eaf6fb;            /* Background Senada Lebih Muda */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #1f2937; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 5px solid var(--primary-color); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px; }
        .header h1 { color: #111827; font-size: 22px; margin: 0; }
        .header i { color: var(--primary-color); margin-right: 8px; }
        
        .form-section { margin-bottom: 20px; }
        .section-title { font-size: 16px; font-weight: bold; color: #374151; margin-bottom: 10px; border-left: 4px solid var(--primary-color); padding-left: 10px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #374151; }
        
        input, select, textarea { 
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; margin-bottom: 15px; box-sizing: border-box; transition: all 0.3s;
        }
        
        /* CSS Capitalize untuk visual instan, JS nanti menanganinya untuk data PDF */
        input[type="text"], textarea { text-transform: capitalize; }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .hidden { display: none; }
        .btn-submit { width: 100%; background-color: var(--primary-color); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; margin-top: 10px; }
        .btn-submit:hover { background-color: var(--primary-dark); }
        .note { font-size: 12px; color: #6b7280; text-align: center; margin-top: 15px; font-style: italic; }
        
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <div>Sedang memproses PDF...</div>
</div>

<div class="container">
    <div class="header">
        <img src="https://bone.go.id/wp-content/uploads/2019/02/lambang-bone.png" alt="Logo Bone" style="width: 60px; margin-bottom: 10px;">
        <h1><i class="fas fa-landmark"></i> Pelayanan Desa Buareng</h1>
        <p>Kecamatan Kajuara, Kabupaten Bone</p>
    </div>

    <form id="suratForm">
        <div class="form-section">
            <label for="jenisSurat">Pilih Jenis Surat:</label>
            <select id="jenisSurat" onchange="toggleForm()">
                <option value="sku">Surat Keterangan Usaha (SKU)</option>
                <option value="sktm">Surat Keterangan Tidak Mampu (SKTM)</option>
                <option value="domisili">Surat Keterangan Domisili</option>
                <option value="pengantar">Surat Pengantar (SKCK/Nikah)</option>
                <option value="waris">Surat Keterangan Ahli Waris</option>
            </select>
        </div>

        <div class="form-section">
            <div class="section-title">Data Pemohon</div>
            <label>Nama Lengkap</label>
            <input type="text" id="nama" class="auto-capital" placeholder="Sesuai KTP" required>
            
            <label>NIK</label>
            <input type="text" id="nik" maxlength="16" inputmode="numeric" placeholder="16 digit NIK (Angka saja)" required>
            
            <label>Tempat, Tanggal Lahir</label>
            <input type="text" id="ttl" class="auto-capital" placeholder="Contoh: Bone, 12 Januari 1990" required>
            
            <label>Jenis Kelamin</label>
            <select id="jk"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select>
            
            <label>Pekerjaan</label>
            <input type="text" id="pekerjaan" class="auto-capital" required>
            
            <label>Agama</label>
            <select id="agama">
                <option value="Islam">Islam</option><option value="Kristen">Kristen</option>
                <option value="Katolik">Katolik</option><option value="Hindu">Hindu</option><option value="Buddha">Buddha</option>
            </select>
            
            <label>Alamat</label>
            <textarea id="alamat" class="auto-capital" rows="2" required></textarea>
        </div>

        <div id="form-sku" class="form-section"><div class="section-title">Detail Usaha</div><label>Nama Usaha</label><input type="text" id="nama_usaha" class="auto-capital"><label>Jenis Usaha</label><input type="text" id="jenis_usaha" class="auto-capital"></div>
        <div id="form-pengantar" class="form-section hidden"><div class="section-title">Keperluan</div><label>Tujuan/Keperluan</label><textarea id="keperluan_pengantar" class="auto-capital"></textarea></div>
        <div id="form-sktm" class="form-section hidden"><div class="section-title">Detail SKTM</div><label>Keperluan</label><input type="text" id="keperluan_sktm" class="auto-capital"></div>
        <div id="form-waris" class="form-section hidden"><div class="section-title">Data Almarhum</div><label>Nama Almarhum</label><input type="text" id="nama_alm" class="auto-capital"><label>Tanggal Meninggal</label><input type="date" id="tgl_meninggal"></div>

        <button type="button" class="btn-submit" onclick="generatePDF()">
            <i class="fas fa-print"></i> Cetak PDF & Kirim
        </button>
        <p class="note">Pastikan internet lancar agar PDF dapat diproses.</p>
    </form>
</div>

<script>
    // --- KONFIGURASI SCRIPT ---
    
    // 1. LOGIC KHUSUS NIK (Hanya Angka & Max 16)
    const inputNIK = document.getElementById('nik');
    inputNIK.addEventListener('input', function(e) {
        // Hapus karakter selain angka
        let value = this.value.replace(/[^0-9]/g, '');
        // Potong jika lebih dari 16
        if (value.length > 16) value = value.slice(0, 16);
        this.value = value;
    });

    // 2. LOGIC AUTO TITLE CASE (Huruf Besar Awal Kata)
    function toTitleCase(str) {
        return str.replace(/\w\S*/g, function(txt){
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    }

    // Terapkan ke semua input dengan class 'auto-capital'
    document.querySelectorAll('.auto-capital').forEach(item => {
        item.addEventListener('blur', function() {
            this.value = toTitleCase(this.value);
        });
    });


    // --- SCRIPT PDF SEBELUMNYA ---
    const config = {
        desa: "DESA BUARENG",
        kecamatan: "KECAMATAN KAJUARA",
        kabupaten: "KABUPATEN BONE",
        alamat: "Jl. Poros Bone Sinjai, Kode Pos 92777",
        kades: "IMRAN MAPPEARE, SE",
        nomorWA: "6282319527214"
    };

    const logoOriginal = "https://bone.go.id/wp-content/uploads/2019/02/lambang-bone.png";
    const logoProxy = `https://images.weserv.nl/?url=${encodeURIComponent(logoOriginal)}&w=150&output=png`;
    
    let logoDataUrl = null;

    function loadLogo() {
        const img = new Image();
        img.crossOrigin = "Anonymous"; 
        img.src = logoProxy;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            logoDataUrl = canvas.toDataURL("image/png");
        };
        img.onerror = function() { console.error("Gagal memuat logo."); };
    }
    loadLogo(); 

    function toggleForm() {
        document.getElementById('form-sku').classList.add('hidden');
        document.getElementById('form-pengantar').classList.add('hidden');
        document.getElementById('form-sktm').classList.add('hidden');
        document.getElementById('form-waris').classList.add('hidden');

        const jenis = document.getElementById('jenisSurat').value;
        if (jenis === 'sku') document.getElementById('form-sku').classList.remove('hidden');
        else if (jenis === 'pengantar') document.getElementById('form-pengantar').classList.remove('hidden');
        else if (jenis === 'sktm') document.getElementById('form-sktm').classList.remove('hidden');
        else if (jenis === 'waris') document.getElementById('form-waris').classList.remove('hidden');
    }

    async function generatePDF() {
        document.getElementById('loading').style.display = 'flex';

        if (!window.jspdf) {
            alert("Sistem sedang memuat library. Coba lagi dalam 3 detik.");
            document.getElementById('loading').style.display = 'none';
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Ambil value (Logic TitleCase sudah diterapkan saat user ngetik/blur, tapi kita pastikan lagi disini jika perlu)
            const nama = document.getElementById('nama').value.toUpperCase(); // Nama tetap UPPERCASE di surat resmi
            const nik = document.getElementById('nik').value;
            const ttl = document.getElementById('ttl').value;
            const jk = document.getElementById('jk').value;
            const pekerjaan = document.getElementById('pekerjaan').value;
            const agama = document.getElementById('agama').value;
            const alamat = document.getElementById('alamat').value;
            const jenisSurat = document.getElementById('jenisSurat').value;

            if (!nama || !nik) { 
                alert("Data Nama dan NIK wajib diisi!"); 
                document.getElementById('loading').style.display = 'none';
                return; 
            }
            if (nik.length !== 16) {
                alert("NIK harus 16 digit angka!");
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // --- HEADER (KOP SURAT) ---
            if (logoDataUrl) {
                try {
                    doc.addImage(logoDataUrl, 'PNG', 20, 15, 23, 27);
                } catch (e) { console.warn("Logo skip", e); }
            } else {
                doc.setDrawColor(150); doc.rect(20, 15, 23, 27);
                doc.setFontSize(8); doc.text("Logo", 26, 30);
            }

            doc.setFont("times", "bold");
            doc.setFontSize(14);
            doc.text("PEMERINTAH KABUPATEN BONE", 115, 20, null, null, "center");
            doc.text(config.kecamatan, 115, 26, null, null, "center");
            doc.setFontSize(18);
            doc.text(config.desa, 115, 34, null, null, "center");
            doc.setFont("times", "normal");
            doc.setFontSize(11);
            doc.text(config.alamat, 115, 40, null, null, "center");

            doc.setLineWidth(1); doc.line(20, 45, 190, 45);
            doc.setLineWidth(0.5); doc.line(20, 46, 190, 46);

            // --- ISI SURAT ---
            let judulSurat = "", nomorSurat = "", isiSurat = "";
            let yPos = 80; const lh = 6.5; 

            if (jenisSurat === 'sku') {
                judulSurat = "SURAT KETERANGAN USAHA";
                nomorSurat = "Nomor: 503 / ... / DB / " + new Date().getFullYear();
                isiSurat = "Yang bertanda tangan di bawah ini Kepala Desa Buareng, Kecamatan Kajuara, Kabupaten Bone menerangkan dengan sebenarnya bahwa:";
            } else if (jenisSurat === 'sktm') {
                judulSurat = "SURAT KETERANGAN TIDAK MAMPU";
                nomorSurat = "Nomor: 401 / ... / DB / " + new Date().getFullYear();
                isiSurat = "Yang bertanda tangan di bawah ini Kepala Desa Buareng menerangkan bahwa warga di bawah ini tergolong Keluarga Tidak Mampu / Pra Sejahtera.";
            } else if (jenisSurat === 'domisili') {
                judulSurat = "SURAT KETERANGAN DOMISILI";
                nomorSurat = "Nomor: 470 / ... / DB / " + new Date().getFullYear();
                isiSurat = "Yang bertanda tangan di bawah ini Kepala Desa Buareng menerangkan bahwa warga di bawah ini adalah benar-benar Penduduk yang berdomisili di Desa Buareng.";
            } else if (jenisSurat === 'pengantar') {
                judulSurat = "SURAT PENGANTAR";
                nomorSurat = "Nomor: 140 / ... / DB / " + new Date().getFullYear();
                isiSurat = "Yang bertanda tangan di bawah ini Kepala Desa Buareng menerangkan bahwa:";
            } else if (jenisSurat === 'waris') {
                judulSurat = "SURAT KETERANGAN AHLI WARIS";
                nomorSurat = "Nomor: 474 / ... / DB / " + new Date().getFullYear();
                isiSurat = "Yang bertanda tangan di bawah ini Kepala Desa Buareng menerangkan bahwa:";
            }

            doc.setFont("times", "bold"); doc.setFontSize(14);
            doc.text(judulSurat, 105, 55, null, null, "center");
            doc.setLineWidth(0.5); doc.line(70, 56, 140, 56);
            doc.setFontSize(12); doc.setFont("times", "normal");
            doc.text(nomorSurat, 105, 62, null, null, "center");
            
            const safeWidth = 160; 
            const isiSplit = doc.splitTextToSize(isiSurat, safeWidth);
            doc.text(isiSplit, 20, 75, { align: "justify", maxWidth: safeWidth });

            yPos = 75 + (isiSplit.length * 6) + 8;

            const dataDiri = [
                ["Nama Lengkap", `: ${nama}`], ["NIK", `: ${nik}`], ["Tempat/Tgl Lahir", `: ${ttl}`],
                ["Jenis Kelamin", `: ${jk}`], ["Pekerjaan", `: ${pekerjaan}`], ["Agama", `: ${agama}`]
            ];
            
            dataDiri.forEach(row => {
                doc.text(row[0], 30, yPos); doc.text(row[1], 80, yPos); yPos += lh;
            });
            
            doc.text("Alamat", 30, yPos);
            const alamatSplit = doc.splitTextToSize(`: ${alamat}`, 110);
            doc.text(alamatSplit, 80, yPos);
            yPos += (alamatSplit.length * lh);

            yPos += 5;
            if (jenisSurat === 'sku') {
                doc.text("Benar yang bersangkutan mempunyai usaha:", 20, yPos); yPos += lh;
                doc.text("Nama Usaha", 30, yPos); doc.text(`: ${document.getElementById('nama_usaha').value}`, 80, yPos); yPos += lh;
                doc.text("Jenis Usaha", 30, yPos); doc.text(`: ${document.getElementById('jenis_usaha').value}`, 80, yPos);
            } else if (jenisSurat === 'pengantar') {
                const ket = doc.splitTextToSize(`Keperluan: ${document.getElementById('keperluan_pengantar').value}`, safeWidth);
                doc.text(ket, 20, yPos);
                yPos += (ket.length * 6);
            } else if (jenisSurat === 'sktm') {
                doc.text(`Keperluan: ${document.getElementById('keperluan_sktm').value}`, 20, yPos);
            } else if (jenisSurat === 'waris') {
                 doc.text("Adalah benar Ahli Waris dari Almarhum:", 20, yPos); yPos += lh;
                 doc.text("Nama Almarhum", 30, yPos); doc.text(`: ${document.getElementById('nama_alm').value}`, 80, yPos); yPos += lh;
                 doc.text("Meninggal Tgl", 30, yPos); doc.text(`: ${document.getElementById('tgl_meninggal').value}`, 80, yPos);
            }

            yPos += 15;
            const penutupSplit = doc.splitTextToSize("Demikian surat ini dibuat untuk dipergunakan sebagaimana mestinya.", safeWidth);
            doc.text(penutupSplit, 20, yPos, { align: "justify", maxWidth: safeWidth });
            
            if (yPos + 50 > 280) { 
                doc.addPage();
                yPos = 20; 
            }

            const yTTD = yPos + 10;
            const dateStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            doc.text(`Buareng, ${dateStr}`, 140, yTTD, null, null, "center");
            doc.text("Kepala Desa,", 140, yTTD + 7, null, null, "center");
            doc.setFont("times", "bold");
            doc.text(config.kades, 140, yTTD + 35, null, null, "center");
            doc.setLineWidth(0.5); doc.line(115, yTTD + 36, 165, yTTD + 36);

            doc.save(`${judulSurat}_${nama}.pdf`);
            document.getElementById('loading').style.display = 'none';

            setTimeout(() => {
                const pesan = `Assalamualaikum, saya ${nama} sudah melampirkan file pdf ${judulSurat}. Mohon TTD.`;
                const urlWA = `https://wa.me/${config.nomorWA}?text=${encodeURIComponent(pesan)}`;
                const userConfirmed = confirm("File PDF sedang diunduh.\n\nJika sudah muncul notifikasi download selesai, klik 'OK' untuk kirim ke WhatsApp.");
                if (userConfirmed) window.open(urlWA, '_blank');
            }, 1000);

        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            alert("Terjadi kesalahan sistem: " + error.message);
            console.error(error);
        }
    }
</script>

</body>
</html>
